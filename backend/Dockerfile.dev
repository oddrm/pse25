FROM rust:latest as builder
WORKDIR /app


# Install build deps
RUN apt-get update && apt-get install -y \
    libpq-dev \
    gcc \
    python3 \
    libpython3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install cargo-watch for fast in-container rebuilds
RUN cargo install cargo-watch

# Copy manifest to cache dependencies layer
COPY Cargo.toml Cargo.lock ./
RUN mkdir src && echo 'fn main() { println!("dummy"); }' > src/main.rs && cargo build --release || true

FROM rust:latest
WORKDIR /app

# Runtime build deps (same as builder to allow building native deps)
RUN apt-get update && apt-get install -y \
    libpq-dev \
    gcc \
    python3 \
    libpython3-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy cached target from builder and cargo-installed binaries (cargo-watch)
COPY --from=builder /app/target ./target
COPY --from=builder /usr/local/cargo/bin /usr/local/cargo/bin
ENV PATH="/usr/local/cargo/bin:${PATH}"

# Copy source into image (compose.dev will usually mount the source for live edits)
COPY . .

# Use the same target dir so cached artifacts are reused
ENV CARGO_TARGET_DIR=/app/target

# Default: watch sources and run for fast rebuilds when files change
CMD ["cargo", "watch", "-x", "run"]
